#include "CoreMinimal.h"
#include "EcosystemWallet/Primitives/Sessions/SessionsTopology.h"
#include "Misc/AutomationTest.h"
#include "Util/SequenceSupport.h"

IMPLEMENT_SIMPLE_AUTOMATION_TEST(FSessionsTopologyFromTree, "SequencePlugin.UnitTests.EcosystemWallet.SessionsTopologyFromTree", EAutomationTestFlags::ApplicationContextMask | EAutomationTestFlags::ProductFilter)
bool FSessionsTopologyFromTree::RunTest(const FString& Parameters)
{
    const FString ServiceTree = "[[{\"data\":\"0x03\"},{\"data\":\"0x04957640f9a397aefeaf83a61c1360627658e15e70\"}],[{\"data\":\"0x04764b75df6c49d4decdc0e331066cb077f55de0cd\"},{\"data\":\"0x00a50bc8f9e68846e9fedab74b544f71fc2439d1ad0000000000000000000000000000000000000000000000000000000000066eee000000000000000000000000000000000000000000000000000000000000000000000199b5b155d00133985d320809e26274a72e03268c8a29927bc6da00\"}]]";
    const FString ExpectedIdentitySigner = "0x957640f9a397aefeaf83a61c1360627658e15e70";
    
    const TSharedPtr<FJsonValue> JsonValue = USequenceSupport::ParseJsonValue(ServiceTree);
    const TSharedPtr<FSessionsTopology> SessionsTopology = FSessionsTopology::FromServiceConfigTree(JsonValue);
    
    if (!SessionsTopology.IsValid())
    {
        UE_LOG(LogTemp, Display, TEXT("Failed to parse topology from service tree"));
        return false;
    }

    const FString IdentitySigner = SessionsTopology.Get()->GetIdentitySigner();

    if (IdentitySigner == "")
    {
        UE_LOG(LogTemp, Display, TEXT("Unable to find identity signer in topology"));
        return false;
    }
    
    TestEqual("Identity signers should match", IdentitySigner, ExpectedIdentitySigner);
    
    return true;
}

IMPLEMENT_SIMPLE_AUTOMATION_TEST(FSessionsTopologyExplicitSigners, "SequencePlugin.UnitTests.EcosystemWallet.SessionsTopologyExplicitSigners", EAutomationTestFlags::ApplicationContextMask | EAutomationTestFlags::ProductFilter)
bool FSessionsTopologyExplicitSigners::RunTest(const FString& Parameters)
{
    const FString ServiceTree = "[[[[[{\"data\":\"0x03\"},[{\"data\":\"0x048a261c1c227f653f26b468615afa440c6f706376\"},{\"data\":\"0x00d0f081baae4b1ae3fcf74ce063f1529550a2424d0000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068f152f6011f3abc3c5e4ac0601a21183380ed426e06ec694a0100688d2232000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000\"}]],[{\"data\":\"0x0060549865f35a4febceb728215436bf96c6beba840000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000000000000000000000001b04d6710c00133985d320809e26274a72e03268c8a29927bc6da00\"},[{\"data\":\"0x00f6fd65f3fc4cf820c154657ddc0479b7511348530000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000000000000000000000001b04d6710c00133985d320809e26274a72e03268c8a29927bc6da00\"},{\"data\":\"0x00029c0bb2fffb213c9f81bc722dcb05a8623c4a580000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068cbbdf702d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010040d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"}]]],[[{\"data\":\"0x00f4d315596ca0eb0d26aa1d51f156438e1c11fd470000000000000000000000000000000000000000000000000000000000066eee000000000000000000000000000000000000000000000000000000000000000000000199858dfc780133985d320809e26274a72e03268c8a29927bc6da00\"},[{\"data\":\"0x00739d2caab5281dac924f0e379d0e63044d93963a0000000000000000000000000000000000000000000000000000000000066eee000000000000000000000000000000000000000000000000000000000000000000000199924a83c80133985d320809e26274a72e03268c8a29927bc6da00\"},{\"data\":\"0x00c85026b14fc2c9d24815cbf7c31015c04836ef3d0000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000000000000000000000001998595f3880133985d320809e26274a72e03268c8a29927bc6da00\"}]],[{\"data\":\"0x005b6cea50f328ea14293e1b6f1d652e583d6669dd000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000019992656698027f5c764cbc14f9669b88837ca1490cca17c316070033985d320809e26274a72e03268c8a29927bc6da00\"},[{\"data\":\"0x00b29b7576cb4d5d096648febe0c35c28493b193ca0000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068d530da02d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"},{\"data\":\"0x00c3b69a258c76fb469266ae6d3bf8ec6011d367d40000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000019985bd80880133985d320809e26274a72e03268c8a29927bc6da00\"}]]]],[[[{\"data\":\"0x00781dedc97e7124f4fa7205d5f2fac678338cb7b00000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000019985c10ac80133985d320809e26274a72e03268c8a29927bc6da00\"},[{\"data\":\"0x00bb28b9882b3f06eca84f5589774869a35d3c0c9d0000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000019985c9a5e80133985d320809e26274a72e03268c8a29927bc6da00\"},{\"data\":\"0x00973ca0b0cdf489ab457d1ef789ab9865ffc0b9ae0000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000019985d8c1180133985d320809e26274a72e03268c8a29927bc6da00\"}]],[{\"data\":\"0x00188ebe524418979eba5f2ad8cfe2f0b1c01758390000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000000000000000000000001998b36f5f80133985d320809e26274a72e03268c8a29927bc6da00\"},[{\"data\":\"0x004d0fcf3512a6b45e386ea359b6cff3cac2e682500000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068d6b5e302d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"},{\"data\":\"0x002779a7978250189e7cb5e82aa4a1214d6c325ed90000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068d6bc1302d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"}]]],[[{\"data\":\"0x007a761ec70a56b190d29f8ced8d4d556218fb457b0000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068da383d02d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"},[{\"data\":\"0x00271eb831c1f6d829fd30955dbd8b08324f90a17a0000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068da6bf502d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"},{\"data\":\"0x00245adb9e1b24a211c94199ffc7641aa7a98f2ade0000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000000000000000000000001999a45ba480133985d320809e26274a72e03268c8a29927bc6da00\"}]],[{\"data\":\"0x04ba3c6b4b146e8db73e2e13154c83c29604e8c706\"},[{\"data\":\"0x0064c11288558c5b2ce9d8f1433402f2396c5c84e70000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000f424000000199aca789c80133985d320809e26274a72e03268c8a29927bc6da00\"},{\"data\":\"0x00ff2fbd9bdd62dda329dcc91ad38ceb1b6ccee3eb0000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068dbfd1d02d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"}]]]]],[[[[{\"data\":\"0x0051bb4fea7b464a6874f2f6c7b7e9ea41e2070b150000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068dc01bb02d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"},[{\"data\":\"0x003a7462e6a05b9a3170f929d1218418b4859432a30000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068dcdb1502d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"},{\"data\":\"0x00e1f3f78039efec25e01b3617e7e0e0c775e25d270000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068dcdba502d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"}]],[{\"data\":\"0x009576f43ee0446f4ae3ccd813437c72f51e60b9ad0000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068dcdaa201d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b020040d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000bd7f38b943452e0c14d7ba92b9b504a9c9fc35180000000000000000000000000000000000000000000000000000000000000004000000000000000000000000ffffffffffffffffffffffffffffffffffffffff\"},[{\"data\":\"0x004e115ce552dbafb1e2508b2a77b54be0702abd370000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068ddbf6801d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b0100000000000000000000000000bd7f38b943452e0c14d7ba92b9b504a9c9fc35180000000000000000000000000000000000000000000000000000000000000004000000000000000000000000ffffffffffffffffffffffffffffffffffffffff\"},{\"data\":\"0x003363e226ba366dae5bb7937574acce7eececd3460000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068ddc00f0133985d320809e26274a72e03268c8a29927bc6da00\"}]]],[[{\"data\":\"0x00864ed2a3726480cac21dcf04c3188faca3f797500000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068ddca1b01d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b0100000000000000000000000000bd7f38b943452e0c14d7ba92b9b504a9c9fc35180000000000000000000000000000000000000000000000000000000000000004000000000000000000000000ffffffffffffffffffffffffffffffffffffffff\"},[{\"data\":\"0x00e85ed1f36834e8a3df6e61d99e28a196ebb71ae80000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068dcefa401d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b020040d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000bd7f38b943452e0c14d7ba92b9b504a9c9fc35180000000000000000000000000000000000000000000000000000000000000004000000000000000000000000ffffffffffffffffffffffffffffffffffffffff\"},{\"data\":\"0x00e77baacd9251d57d5a3b0813f292da5573f344c80000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068ddf2c60133985d320809e26274a72e03268c8a29927bc6da00\"}]],[{\"data\":\"0x00ad19a97389d599b36cdfc249736a1faff204af550000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068dd1f1502d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"},[{\"data\":\"0x00feb86005410bf8569803c8cabe3de2c9823fa72b0000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068de02f70133985d320809e26274a72e03268c8a29927bc6da00\"},{\"data\":\"0x00836eade0eb8f7e4debad790c0cfe49876967a8d30000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068de046d0133985d320809e26274a72e03268c8a29927bc6da00\"}]]]],[[[{\"data\":\"0x00a6efa89208e2fb84b40e1321abd74499856929a60000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068dd37ad02d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"},[{\"data\":\"0x00afe112849221b8809937a6be54d3e03553f559dd0000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068dd408101d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b020040d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000bd7f38b943452e0c14d7ba92b9b504a9c9fc35180000000000000000000000000000000000000000000000000000000000000004000000000000000000000000ffffffffffffffffffffffffffffffffffffffff\"},{\"data\":\"0x00e306b7508d8a0713f2bf11a019ea356085b2c99e0000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000de0b6b3a76400000000000068dd5a8002d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b010140d097c3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000fcf6eb210e5fd84d679b14fe170f9ab05c9b21e700\"}]],[{\"data\":\"0x00da75bad7af4f6e455e22d09082da1f865db96bbf0000000000000000000000000000000000000000000000000000000000066eee00000000000000000000000000000000000000000000000000000000000000000000000068de73dc01d25b37e2fb07f85e9eca9d40fe3bcf60ba2dc57b0100000000000000000000000000bd7f38b943452e0c14d7ba92b9b504a9c9fc35180000000000000000000000000000000000000000000000000000000000000004000000000000000000000000ffffffffffffffffffffffffffffffffffffffff\"},[{\"data\":\"0x00a0cb04985baf1d4f411114ba67b3b7fee7f87e0b0000000000000000000000000000000000000000000000000000000000066eee000000000000000000000000000000000000000000000000000000000000000000000199b5a709180133985d320809e26274a72e03268c8a29927bc6da00\"},{\"data\":\"0x00e64d993419b38a107c0c821d1c9ffe937d35d6a1000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000199b5a74f68027f5c764cbc14f9669b88837ca1490cca17c316070033985d320809e26274a72e03268c8a29927bc6da00\"}]]],[[{\"data\":\"0x008087348e54b6da7ffe5aba0cabce94c0dbefebb60000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000000000000000000000001b04d6710c00133985d320809e26274a72e03268c8a29927bc6da00\"},[{\"data\":\"0x00fe122b2e0b7c2a08f13e61dfc8d931f0a83e9c700000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000000000000000000000001b04d6710c00133985d320809e26274a72e03268c8a29927bc6da00\"},{\"data\":\"0x00e7a9f4183abdf221de652da7892aa164d9490eda0000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000000000000000000000001b04d6710c00133985d320809e26274a72e03268c8a29927bc6da00\"}]],[{\"data\":\"0x003a80ce518f6c0a04093c26be43d3e40b43975bd30000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000000000000000000000001b04d6710c00133985d320809e26274a72e03268c8a29927bc6da00\"},[{\"data\":\"0x00a3f9bccc7db1b9d5c8ea9abcf89a9c2dbc33737c0000000000000000000000000000000000000000000000000000000000066eee0000000000000000000000000000000000000000000000000000000000000000000001b04d6710c00133985d320809e26274a72e03268c8a29927bc6da00\"},{\"data\":\"0x00ada67240aa40f89e467701ee2d8c1127f72ed6300000000000000000000000000000000000000000000000000000000000066eee000000000000000000000000000000000000000000000000000000000000000000000199e18c1c800133985d320809e26274a72e03268c8a29927bc6da00\"}]]]]]]";
    const FString ExpectedExplicitSigner = "0x957640f9a397aefeaf83a61c1360627658e15e70";
    
    const TSharedPtr<FJsonValue> JsonValue = USequenceSupport::ParseJsonValue(ServiceTree);
    const TSharedPtr<FSessionsTopology> SessionsTopology = FSessionsTopology::FromServiceConfigTree(JsonValue);
    
    if (!SessionsTopology.IsValid())
    {
        UE_LOG(LogTemp, Display, TEXT("Failed to parse topology from service tree"));
        return false;
    }

    const TArray<FString> ExplicitSigners = SessionsTopology.Get()->GetExplicitSigners();

    for (FString ExplicitSigner : ExplicitSigners)
    {
        UE_LOG(LogTemp, Display, TEXT("Explicit signer in topology: %s"), *ExplicitSigner);
    }
    
    return true;
}